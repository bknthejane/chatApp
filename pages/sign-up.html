<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chatty - Sign up</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/styles/styles.css" rel="stylesheet" />
</head>

<body>
    <header>
        <div class="header-content">
            <div class="header-logo">Chatty</div>
            <nav class="nav-links">
                <a href="/index.html" class="nav-link">Home</a>
                <a href="#" class="nav-link">Login</a>
                <a href="/pages/sign-up.html" class="nav-link active">Sign Up</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="signup-container">
            <div class="logo">Chatty</div>
            <h1>Create your account</h1>

            <form id="signupForm">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" placeholder="Enter your full name" required />
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="text" id="email" name="email" placeholder="Enter your email address" required />
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" placeholder="Choose a username" required />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Create a Password" required />
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword"
                        placeholder="Confirm your password" required />
                </div>

                <button type="submit" class="btn">Create Account</button>
            </form>

            <div class="footer">
                <p>Already have an account? <a href="/pages/login.html">Log in</a></p>
            </div>
        </div>
    </main>

    <script src="/js/signup.js"></script>

    <script>
        // Wait for Html to fully load before running any Javascript
        document.addEventListener('DOMContentLoaded', function () {
            // Get reference to the form used in HTML using its id to attach listner:
            const signupForm = document.getElementById('signupForm');

            //Initialise an empty list of users in localStorage:
            if (!localStorage.getItem('users')) {
                //Use stringify or parse since localStorage only stores strings
                localStorage.setItem('users', JSON.stringify([]));
            }

            //To prevent page reload (default), therefore form submission will be handled manually:
            signupForm.addEventListener('submit', function (event) {
                event.preventDefault();

                //Get form data
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Check if any of the required fields are empty
                if (!fullName || !email || !username || !password || !confirmPassword) {
                    showError('All fields are required');
                    return;
                }

                // Usage of regualr expression to check email address looks valid:
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('Please enter a valid email address');
                    return;
                }

                if (password !== confirmPassword) {
                    showError('Passwords do not match');
                    return;
                }

                if (password.length < 6) {
                    showError('Password must be at least 6 characters long');
                    return;
                }

                //Gets the existing users from localStorage:
                const users = JSON.parse(localStorage.getItem('users'));
                const usernameExists = users.some(user => user.username.toLowerCase() === username.toLowerCase());

                if (usernameExists) {
                    showError('Username already exists. Please choose another one.');
                    return;
                }


                //Create and store new user:
                const newUser = {
                    fullName,
                    email,
                    username,
                    password,
                    profilePic: '',
                    online: false,
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                //Sets up an empty message structure for the new user
                localStorage.setItem(`messages_${username}`, JSON.stringify({ group: [], private: {} }));

                showSuccess('Account created successfully! Redirecting to login...');

                setTimeout(() => {
                    window.location.href = '/pages/login.html';
                }, 2000);
            });


            // Helper functions to display a temporary error message near the submit button:
            function showError(message) {
                let errorElement = document.querySelector('.error-message');

                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.className = 'error-message';
                    signupForm.insertBefore(errorElement, signupForm.querySelector('button'));
                }

                errorElement.textContent = message;
                errorElement.style.display = 'block';

                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 3000);
            }


            // Helper function to display success message
            function showSuccess(message) {
                let successElement = document.querySelector('.success-message');

                if (!successElement) {
                    successElement = document.createElement('div');
                    successElement.className = 'success-message';
                    signupForm.insertBefore(successElement, signupForm.querySelector('button'));
                }

                successElement.textContent = message;
                successElement.style.display = 'block';
            }
        });
    </script>
</body>

</html>